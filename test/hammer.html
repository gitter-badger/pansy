<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Document</title>
  <meta name="viewport" content="width=device-width, user-scalable=no">
  <script src="hammer.js"></script>
</head>
<body>


<!--   <div id="block" style="transform: translate3d(200px, 100px, 50px) rotate3d(0, 0, 0, 0deg) scale(1, 1)" data-transform="{translate:{"x\":1}}"></div>
   -->
  <div id="block"></div>

  <style>

html {
  width: 100%;
  height: 100%;
}

body {
  margin: 0;
  width: 100%;
  height: auto;
  min-height: 100%;
  overflow: hidden;
}

#block {
  width: 100px;
  height: 100px;
  background-color: #000;
}

.active {
  transition: all .3s ease;
}

  </style>



  <script>


  var reqAnimationFrame = (function () {
      return window[Hammer.prefixed(window, 'requestAnimationFrame')] || function (callback) {
          window.setTimeout(callback, 1000 / 60);
      };
  })();

  var timer;
  var ticking = false;
  var transform = {}
  var startTranslate= {};
  var log = [];

  var el = document.querySelector("#block");
  var mc = new Hammer.Manager(el);

  mc.add(new Hammer.Pan({
      threshold: 0,
      pointers: 0
  }));

  mc.add(new Hammer.Swipe()).recognizeWith(mc.get('pan'));
  mc.add(new Hammer.Rotate({
      threshold: 0
  })).recognizeWith(mc.get('pan'));
  mc.add(new Hammer.Pinch({
      threshold: 0
  })).recognizeWith([mc.get('pan'), mc.get('rotate')]);

  mc.add(new Hammer.Tap({
      event: 'doubletap',
      taps: 2
  }));
  mc.add(new Hammer.Tap());


  mc.on("panstart panmove", onPan);
  mc.on("doubletap", onDoubleTap);
  mc.on("hammer.input", function(ev) {
      if(ev.isFinal) {
          resetElement();
      }
  });



  resetElement()

  function logEvent(ev) {
      //el.innerText = ev.type;
      log.push(ev)
  }

  function resetElement() {

    if (typeof transform.prev == 'undefined') {
      /**
       * 初始化 transform
       */
      var styleTransform = el.style.transform || el.style['-webkit-transform'] || el.style['-moz-transform']
      var translate3d = {x: 0, y: 0, z: 0 }
      var scale = {x: 1, y: 1}
      var rotate3d = {x: 0, y: 0, z: 0, angle: 0}
      if (styleTransform != null && styleTransform != '') {

        styleTransform = styleTransform.toLowerCase()
        var a = styleTransform.match(/(?:translate3d).+?\)/)
        if (a != null) {
          var a1 = a[0].split(/translate3d/)[1].match(/\d+/g)
          translate3d = {x: Number(a1[0]), y: Number(a1[1]), z: Number(a1[2]) }
        }

        var b = styleTransform.match(/(?:scale).+?\)/)
        if (b != null) {
          var b1 = b[0].split(/scale/)[1].match(/\d+/g)
          scale = {x: Number(b1[0]), y: Number(b1[1])}
        }

        var c = styleTransform.match(/(?:rotate3d).+?\)/)
        if (c != null) {
          var c1 = c[0].split(/rotate3d/)[1].match(/\d+/g)
          rotate3d = {x: Number(c1[0]), y: Number(c1[1]), z: Number(c1[2]) , angle: Number(c1[3])}
        }

      }


      transform = {
        translate3d: translate3d,
        scale: scale,
        rotate3d: rotate3d
      }
    }

    transform.prev = {
      translate3d: JSON.parse(JSON.stringify(transform.translate3d)),
      scale: JSON.parse(JSON.stringify(transform.scale)),
      rotate3d: JSON.parse(JSON.stringify(transform.rotate3d))
    }

  }

  function requestElementUpdate(ev) {
      logEvent(ev);
      if(!ticking) {
          reqAnimationFrame(updateElementTransform);
          ticking = true;
      }
  }

  function updateElementTransform() {

      var value = [
        'translate3d(' + transform.translate3d.x + 'px, ' + transform.translate3d.y + 'px, 0)',
        'scale(' + transform.scale.x + ', ' + transform.scale.y + ')',
        'rotate3d('+ transform.rotate3d.x +','+ transform.rotate3d.y +','+ transform.rotate3d.z +','+  transform.rotate3d.angle + 'deg)'
      ];

      value = value.join(" ");
      el.style.webkitTransform = value;
      el.style.mozTransform = value;
      el.style.transform = value;
      ticking = false;
  }


  function onPan(ev) {
    console.log('onpan')


      transform.translate3d.x = transform.prev.translate3d.x + ev.deltaX
      transform.translate3d.y = transform.prev.translate3d.y + ev.deltaY

      if (transform.translate3d.x < 0 ) {
        transform.translate3d.x = 0
      }

      if (transform.translate3d.x > window.innerWidth - el.offsetWidth) {
        transform.translate3d.x = window.innerWidth - el.offsetWidth
      };

      if (transform.translate3d.y < 0 ) {
        transform.translate3d.y = 0
      }

      if (transform.translate3d.y > window.innerHeight - el.offsetHeight) {
        transform.translate3d.y = window.innerHeight - el.offsetHeight
      };

      requestElementUpdate(ev);
  }

  function onDoubleTap(ev) {


    transform.translate3d = {x: 0, y: 0, z: 0}
    transform.scale = {x: 1, y: 1}
    transform.rotate3d = {x: 0, y:0, z: 0, angle: 0}

    requestElementUpdate(ev);
    resetElement()

  }



  </script>

</body>
</html>