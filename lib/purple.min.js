/*! PURPLE.js v0.6.0-SNAPSHOT 2015-06-24 */
!function(a){function b(){function a(a){function c(a){return"undefined"==typeof l.app[a.name]?b(a):l.app[a.name]}return"undefined"==typeof a?c({name:"__anonymous"}):"string"==typeof a?c({name:a}):"object"==typeof a?c(j({name:"__anonymous"},a)):void 0}function b(a){console.log("正在创建app:"+a.name);var b=j({filter:{},spa:!1,timeout:45e3,exceptionHandler:function(a,b,c,d){a?(console.error(a),c.end()):d()},notFoundHandle:function(a,b){b.end()}},a),d=c({spa:!1,complete:!0,prevUrl:"",curUrl:location.href},b);return l.app[a.name]={conf:b,state:d,middleware:[],list:{},set:function(a,b){var e=this,f=j({},e.conf);"object"==typeof a?f=j(f,a):f[a]=b,f.name=e.conf.name,e.state=c(d,f),e.conf=f},use:function(a){this.middleware.push(a)},route:function(a){var b,c=this;if(g(a))b=new RegExp("(^"+a.join("$)|(^")+"$)");else if(f(a))b=new RegExp("^"+a+"$");else{if(!h(a))return!1;b=a}return c.list[b]={regexp:b,get:function(){this.fns=Array.prototype.slice.call(arguments,0)}},c.list[b]},go:function(a,b){function c(a){"undefined"!=typeof a&&null!=a?f.conf.exceptionHandler(a,g,h,c):f.state.complete||(i.length>0?i.shift()(g,h,c):h.end())}function d(a,b,c){console.log("正在解析地址："+a.rawUrl);var d=a.parsedUrl,e=!0,g=d.match(f.conf.filter.pathname);if(g?d=d.substr(Object(g[0]).length):(console.warn("routePath不符合pathname过滤规则，浏览器重定向到请求网址"),location.replace(a.rawUrl)),"undefined"!=typeof f.conf.filter.search){var h=f.conf.filter.search;d="undefined"!=typeof a.searches[h]&&""!=a.searches[h]?a.searches[h]:"/"}console.log("过滤后的routePath: "+d),f.state.spa&&("replace"==a.historyStateType?history.replaceState("data","title",a.parsedURL):history.pushState("data","title",a.parsedURL));for(var j in f.list)if(f.list.hasOwnProperty(j)&&f.list[j].regexp.test(d))return console.log("解析路由成功："+f.list[j].regexp),i=i.concat(f.middleware,f.list[j].fns),e=!1,c();e&&(console.warn("该地址无法解析："+a.rawUrl),f.conf.notFoundHandle(a,b))}if(null==a)return console.warn("app.go不接受null参数"),!1;var f=this;if(!f.state.complete)return!1;f.state.complete=!1;var g=j(e(a),{rawUrl:a,historyStateType:b||"push"}),h={end:function(){f.state.complete=!0,console.log("路由跳转完毕。")},redirect:function(a){this.end(),f.go(a)}},i=[d].concat(f.middleware);setTimeout(function(){console.warn("超时"),h.end()},f.conf.timeout),c()}},l.app[a.name]}function c(b,c){function e(){a(c.name).go(location.href)}function f(b){a(c.name).go(d(b))}return c.spa&&!b.spa?(b.spa=!0,window.addEventListener("popstate",e,!1),document.addEventListener("click",f,!1)):!c.spa&&b.spa&&(b.spa=!1,window.removeEventListener("popstate",e,!1),document.removeEventListener("click",f,!1)),b}function d(a){function b(a){null==a?c=null:"A"==a.nodeName?c=a.href||null:b(a.parentNode)}var c=null;return b(a.target),null!==c&&a.preventDefault(),c}function e(a){var b=document.createElement("a");b.href=a;var c=b.pathname||"/"+b.pathname,d={rawUrl:b.href,href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:c.replace(/^([^\/])/,"/$1"),pathnames:k(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,searches:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:k(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},e="/"+d.pathnames.join("/");if(!i(d.searches)){e+=String("?");for(var f in d.searches)d.searches.hasOwnProperty(f)&&(e+=f+"=",e+="undefined"!=typeof d.searches[f]?d.searches[f]:"",e+="&");e=e.substring(0,e.length-1)}if(d.hashes.length>0){e+="#";for(var g=0;g<d.hashes.length;g++)e+=g<d.hashes.length-1?d.hashes[g]+String("/"):d.hashes[g]}return d.parsedURL=e,d.parsedUrl=e,d}function f(a){return"string"==typeof a}function g(a){return a instanceof Array}function h(a){return a instanceof RegExp}function i(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function j(){var a={},b=Array.prototype.slice.call(arguments,0);return b.forEach(function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function k(a,b){var c=[];return a.forEach(function(a){a!==b&&c.push(a)}),c}var l={app:{}};return a}"function"==typeof define&&define.amd?define(function(){return b()}):a.purple=b()}(this);