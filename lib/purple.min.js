/*! PURPLE.js v0.6.0-SNAPSHOT 2015-06-19 */
!function(a){function b(){function a(a,c){if(0!==arguments.length){if(e(l.app[a])){var d=l.app[a];if("object"==typeof c){console.log("更新app："+a);var f=j(d.conf,c);d.set(f)}return console.log("返回app："+a),d}return console.log("生成新app: "+a),b(a,c)}return"undefined"==typeof l.app.__anonymous?(console.log("返回匿名app"),l.app.__anonymous=b("__anonymous")):void 0}function b(b,e){function i(b,d,e){function f(b){a(d.name).go(location.href)}function g(b){a(d.name).go(c(b))}var h=j({},b);b.onpopstate&&!d.onpopstate&&window.removeEventListener("popstate",f,!1),!b.onpopstate&&d.onpopstate&&window.addEventListener("popstate",f,!1),b.onanchorclick&&!d.onanchorclick&&document.removeEventListener("click",g,!1),!b.onanchorclick&&d.onanchorclick&&document.addEventListener("click",g,!1),e(null,h)}var k=j({name:b,filter:"/",timeout:45e3,onpopstate:!1,onanchorclick:!1},e),m={res:"complete",onpopstate:!1,onanchorclick:!1};i(m,k,function(a,b){a?console.log("参数错误，创建app失败。"):m=b});var n=l.app[b]={name:b,middleware:[],list:{},conf:k,state:m,currentHref:null,prevHref:null,set:function(a,b){var c=this,d=j({},c.conf);"object"==typeof a?d=j(d,a):d[a]=b,d.name=c.name,i(c.state,d,function(a,b){a?console.log("配置参数有误"):(c.state=b,c.conf=d)})},use:function(a){n.middleware.push(a)},route:function(a){var b;if(g(a))b=new RegExp("^/"+a.join("/")+"/$");else if(f(a))b=new RegExp("^"+a+"$");else{if(!h(a))return!1;b=a}var c=n.list[b]={regexp:b,get:function(){c.fns=Array.prototype.slice.call(arguments,0)}};return c},go:function(a,b){function c(a){g._end||(i.length>0?i.shift()(g,h,c):h.end())}function e(a,b,c){"replace"==a.historyStateType?history.replaceState("data","title",a.parsedURL):"push"==a.historyStateType&&history.pushState("data","title",a.parsedURL),console.log("正在解析地址："+a.rawUrl);for(var d in n.list)if(n.list.hasOwnProperty(d)&&n.list[d].regexp.test(a.pathname))return console.log("解析路由成功："+n.list[d].regexp),i=i.concat(n.list[d].fns),c();return new RegExp(a.app.conf.filter).test(a.pathname)?(console.warn("该地址无法解析："+a.pathname),void b.end()):location.replace(a.rawUrl)}if(null==a)return!1;var f=this;if("pending"==f.state.res)return!1;f.state.res="pending";var g=j(d(a),{_end:!1,rawUrl:a,historyStateType:b||"push"}),h={timestamp:Date.now(),prevView:null,end:function(){f.state.res="complete",g._end=!0,null!=this.prevView&&this.prevView.remove(),console.log("路由跳转完毕...")},redirect:function(a){this.end(),f.go(a)}},i=[e].concat(n.middleware);c()}};return n}function c(a){function b(a){null==a?c=null:"A"==a.nodeName?c=a.href||null:b(a.parentNode)}var c=null;return b(a.target),null!==c&&a.preventDefault(),c}function d(a){var b=document.createElement("a");b.href=a;var c=b.pathname||"/"+b.pathname,d={rawUrl:b.href,href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:c.replace(/^([^\/])/,"/$1"),pathnames:k(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,searches:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:k(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},e="/"+d.pathnames.join("/");if(!i(d.searches)){e+=String("?");for(var f in d.searches)d.searches.hasOwnProperty(f)&&(e+=f+"=",e+="undefined"!=typeof d.searches[f]?d.searches[f]:"",e+="&");e=e.substring(0,e.length-1)}if(d.hashes.length>0){e+="#";for(var g=0;g<d.hashes.length;g++)e+=g<d.hashes.length-1?d.hashes[g]+String("/"):d.hashes[g]}return d.parsedURL=e,d}function e(a){return"undefined"!=typeof a}function f(a){return"string"==typeof a}function g(a){return a instanceof Array}function h(a){return a instanceof RegExp}function i(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function j(){var a={},b=Array.prototype.slice.call(arguments,0);return b.forEach(function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function k(a,b){var c=[];return a.forEach(function(a){a!==b&&c.push(a)}),c}var l={app:{__anonymous:{}}};return a}"function"==typeof define&&define.amd?define(function(){return b()}):a.purple=b()}(this);