/**
 * purple.js v0.3.3 http://purple.heineiuo.com
 * @author Hansel http://heineiuo.com
 */
!function(a){function b(a,b){function c(b){for(name in L.machineNames)q(L.machines[name]);L={},L={timestamp:Date.now(),htmlsuffix:b.htmlsuffix||null,htmlpath:b.htmlpath||"/html/",debug:b.debug||!1,errorHandle:b.errorHandle||B,ajaxErrorHandle:b.ajaxErrorHandle||J,ajaxFailHandle:b.ajaxFailHandle||K,progressHandle:b.progressHandle||C,progressShow:b.progressShow||!1,autoCallback:b.autoCallback||D,listenA:b.listenA||!1,listenP:b.listenP||!1,pending:!1,error:!1,ua:null,jack_id:1,jacks:{},html:{},prevURL:null,eventArray:[],machineNames:[],machines:{},machineMaster:null,events:{},fn:{},scope:new RegExp("^"+(b.scope||location.origin)),config:b},L.debug&&(M.debug=A),L.listenA&&E({eventItem:[document,"click","a",G]}),L.listenP&&E({eventItem:[a,"popstate",H]})}function d(a){return"undefined"!=typeof a}function e(a){return"undefined"==typeof a}function f(a){return null===a||""===a}function g(a){var b=0;for(i in a)b++;return b}function h(a,b){function c(a,b){if(a.length!=b.length)return!1;for(var c=b.length,d=0;c>d;d++)if(a[d]!==b[d])return!1;return!0}for(var d=b.length,e=0;d>e;e++)if("object"==typeof b[e]){if(c(b[e],a))return!0}else if(b[e]==a)return!0;return!1}function j(a,b){if(a.length!=b.length)return!1;for(var c=b.length,d=0;c>d;d++)if(a[d]!==b[d])return!1;return!0}function k(a,b){for(var c=0;c<a.length;c++)a[c]==b&&(a.splice(c,1),c--);return a}function l(a,b){for(var c=0;c<a.length;c++)j(a[c],b)&&(a.splice(c,1),c--);return a}function m(a){return JSON.parse(JSON.stringify(a))}function n(a){function b(a,d){Object.keys(a).forEach(function(e){var f=[];a[e]instanceof Object&&!(a[e]instanceof Array)&&(d.length&&(f=d.concat()),f.push(e),c.push(f),b(a[e],f))})}var c=[];return b(a,[]),c}function o(a){function b(a){Object.keys(a).forEach(function(d){a[d]instanceof Object&&!(a[d]instanceof Array)&&(c.push(d),b(a[d]))})}var c=[];return b(a),c}function p(a){function b(a){return a.parentNode||a.parentElement}function c(a){return/state[a-z]+/.test(a)}var d=b(a);if("HTML"==d.nodeName)return!1;var e=d.id;return""!=e&&c(e)?e.substring(5):p(d)}function q(a){for(var c=0;c<a.eventArray.length;c++){var d=a.eventArray[c];b(d[0]).off(d[1],d[2],d[3])}a.eventArray=[]}function r(a){var b=document.createElement("a");b.href=a;var c=b.pathname||"/"+b.pathname,d={href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:c.replace(/^([^\/])/,"/$1"),pathnames:k(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,searches:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:k(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},e=String();if(e+="/"+d.pathnames.join("/"),g(d.searches)>0){e+=String("?");for(x in d.searches)e+=x+"=",e+="undefined"!=typeof d.searches[x]?d.searches[x]:"",e+="&";e=e.substring(0,e.length-1)}if(d.hashes.length>0){e+="#";for(var f=0;f<d.hashes.length;f++)e+=f<d.hashes.length-1?d.hashes[f]+String("/"):d.hashes[f]}return d.parsedURL=e,d}function s(a,c){function e(a){var b=document.createElement("div");return b.innerHTML=a,b=1==b.childNodes.length?b.childNodes[0]:b}return"undefined"!=typeof c?L.html[a]=e(c):d(L.html[a])||b.ajax({url:L.htmlpath+"/"+a+".html",type:"GET",dataType:"html",async:!1}).done(function(b){L.html[a]=e(b)}).fail(function(a){L.debug&&console.log(a)}),L.html[a]}function t(a,c){function d(a){for(var c=b(L.html[a]).find("[data-jack]"),d=0;d<c.length;d++){var e=c.eq(d),f=e.attr("data-jack");"undefined"==typeof L.jacks[f]&&(L.jack_id++,L.jacks[f]={id:"ppjack"+String(L.jack_id),ready:!1}),"string"==typeof e.attr("id")&&(L.jacks[f].id=e.attr("id")),e.attr("id",L.jacks[f].id),L.debug||e.attr("data-jack",null)}return""!=L.html[a].id?L.jacks[a].id=L.html[a].id:L.html[a].id=L.jacks[a].id,L.html[a]}return L.jacks[a].ready||("undefined"==typeof c?s(a):s(a,c),d(a),L.jacks[a].ready=!0),L.html[a]}function u(a){L.machineNames.push(a.machine);var b={prevDiffState:null,states:{},stateNow:null,statePrev:null,stateNames:[],stateReadyNames:[],eventArray:[],url:null};d(a.routerCondition)?(b.routerCondition=a.routerCondition,b.needCondition=!0):b.needCondition=!1,d(a.notFoundHandle)&&(b.notFoundHandle=a.notFoundHandle),a.master&&(L.machineMaster=a.machine),L.machines[a.machine]=b}function v(a){if(e(L.machines[a.machine]))return!1;for(var b=a.machine,c=a.name,f=c instanceof RegExp?c:new RegExp("^\\/"+c.join("\\/")+"$"),g=a.jack||{},h=a.events||[],i=a.callback||function(){return!0},j=n(g),k=o(g),l=0;l<k.length;l++)"undefined"==typeof L.jacks[k[l]]&&(L.jack_id++,L.jacks[k[l]]={id:"ppjack"+String(L.jack_id),ready:!1});var m=L.machines[b];m.stateNames.push(f);var p={name:c,jack:g,jackarr:j,events:h,callback:i,url:null,jackReady:!1};p.needCondition=d(a.needCondition)?a.needCondition:m.needCondition,d(a.routerCondition)&&(p.needCondition=!0,p.routerCondition=a.routerCondition),L.machines[b].states[f]=p}function w(a){if(L.pending)return!1;if(e(L.machines[a.machine]))return!1;var b=a.href||location.href,c=r(b);y({machine:a.machine,transport:c,type:a.type||"push",clearCache:a.clearCache||!1})}function y(a){function c(a,b,d,e,f){if(a>=L.machines[b].stateNames.length){if(0==d.length)return f(),!1;b=d.shift(),a=0}return a<L.machines[b].stateNames.length&&L.machines[b].stateNames[a].test(e)?(f(b,L.machines[b].stateNames[a]),!1):(a++,void c(a,b,d,e,f))}function e(a,c){if("undefined"==typeof a)M.progress(100),B("ERR_ROUTER_404",j.parsedURL),d(L.machines[L.machineMaster].notFoundHandle)&&L.machines[L.machineMaster].notFoundHandle();else{var e=L.machines[a],f=e.states[c];if(f.needCondition){var g=d(f.routerCondition)?f.routerCondition:e.routerCondition;if(!g())return M.progress(100),L.pending=!1,!1}if(L.pending=!0,j.jackReady=!0,j.callReady=!0,i?(j.jackReady=!1,j.callReady=!1):f.jackReady?j.parsedURL!=f.url&&(j.callReady=!1):(j.jackReady=!1,j.callReady=!1),j.prevURL=e.url,e.url=j.parsedURL,j.statePrevURL=f.url,f.url=j.parsedURL,L.pending=!1,null==e.prevDiffState?e.prevDiffState=c:e.prevDiffState.toString()!=c.toString()&&(j.prevDiffStateURL=e.states[e.prevDiffState].url,e.prevDiffState=c),L.machineMaster==a)switch(h){case"push":history.pushState("data","title",j.parsedURL);break;case"replace":history.replaceState("data","title",j.parsedURL)}M.progress(30),z({machine:a,stateName:c},function(){f.jackReady=!0,M.progress(50),L.autoCallback(),f.callback(j)}),L.debug&&b("#state"+a).attr({"data-router":j.parsedURL})}}M.progress(5);var f=a.machine,g=k(m(L.machineNames),f),h=a.type,i=a.clearCache,j=a.transport;M.progress(15),c(0,f,g,j.pathname,e)}function z(a,c){function d(a){if("undefined"!=typeof L.jacks[a[a.length-1]].loaded)g(a);else{var c=i(a[a.length-1]),d=t(a[a.length-1]);if(null==c){var e=1==a.length?o:i(a[a.length-2]);b(e).append(d)}else b(c).after(d),b(c).remove()}L.jacks[a[a.length-1]].loaded=!0}function e(a){i(a[a.length-1]).style.display="none"}function g(a){i(a[a.length-1]).style.display="block"}function i(a){return document.getElementById(L.jacks[a].id)}var j=a.machine,k=L.machines[j],l=a.stateName,m=k.states[l],o=document.getElementById("state"+j);if(null==o&&(o=document.createElement("div"),o.id="state"+j,document.body.appendChild(o)),f(k.stateNow))for(var p=0;p<m.jackarr.length;p++)d(m.jackarr[p]);else{var r=k.states[k.stateNow];r.jackarr=n(r.jack),q(k);for(var p=0;p<r.jackarr.length;p++)h(r.jackarr[p],m.jackarr)||e(r.jackarr[p]);for(var p=0;p<m.jackarr.length;p++)m.jackReady?g(m.jackarr[p]):h(m.jackarr[p],r.jackarr)?g(m.jackarr[p]):d(m.jackarr[p])}M.progress(40),k.statePrev=k.stateNow,k.stateNow=l;for(var p=0;p<m.events.length;p++)E({machine:j,eventItem:m.events[p]});c()}function A(a){"undefined"==typeof a&&console.log(L)}function B(a,b){if(L.debug){var a=a||"",b=b||"";console.error(a+": "+b)}}function C(a){function c(a){b("#npop").length||b("body").append(b('<div id="npop"><style>#npop{z-index:1000000;position:fixed;top:0;right:0;left:0;height:4px}#npop .power{position:absolute;top:0;bottom:0;left:0;background-color:rgb(85,185,215);transition:all .5s ease}</style><div class="power"></div></div>')),b("#npop .power").css({width:a+"%"})}function d(){b("#npop").remove()}var a=Number(a)||0;switch(a=a>100?100:a,a=0>a?0:a){case 100:c(100),setTimeout(d,500);break;default:c(a)}}function D(){}function E(a){var c=a.eventItem,d="undefined"!=typeof a.machine?L.machines[a.machine].eventArray:L.eventArray;if(!h(c,d))switch(d.push(c),c.length){case 3:b(c[0]).on(c[1],c[2]);break;case 4:b(c[0]).on(c[1],c[2],c[3])}}function F(a){var c=a.eventItem,d="undefined"!=typeof a.machine?L.machines[a.machine].eventArray:L.eventArray;if(h(c,d)){switch(c.length){case 3:b(c[0]).off(c[1],c[2]);break;case 4:b(c[0]).off(c[1],c[2],c[3])}d=l(d,c)}}function G(c){var d=b(c.target).closest("a"),e=d.attr("href")||0,f=d.attr("target")||0;if(0!=e&&0==f){var g=r(e);if(L.scope.test(g.href)){var h=p(d[0]);0!=h&&(c&&c.preventDefault?c.preventDefault():a.event.returnValue=!1,y({machine:h,transport:g,type:"push",clearCache:!1}))}}}function H(){var a=r(location.href);L.scope.test(a.href)&&y({machine:L.machineMaster,transport:a,type:"replace",clearCache:!1})}function I(a){var c=a.url||L.apipath,d=a.callback||function(){},e=a.data||{},f=a.type||"POST",g=a.dataType||"json";b.ajax({url:c,type:f,dataType:g,data:e}).done(function(b){L.debug&&console.log(b),"undefined"==typeof b.error?d(b):"undefined"!=typeof a.error?a.error(b,function(a){a&&L.ajaxErrorHandle(b)}):L.ajaxErrorHandle(b)}).fail(function(){"undefined"!=typeof a.fail?a.fail(e,function(a){a&&L.ajaxFailHandle(e)}):L.ajaxFailHandle(e)})}function J(a){L.debug&&console.log(a)}function K(a){L.debug&&console.log(a)}var L={},M=a.purple={init:function(a){c(a)},machine:function(a){u(a)},newMachine:function(a){u(a)},html:function(a,b){return s(a,b)},on:function(a){E(a)},off:function(a){F(a)},router:function(a){w(a)},route:function(a){w(a)},define:function(a){v(a)},progress:function(a){L.progressShow&&C(a)},parseURL:function(a){return r(a)},getConfig:function(){return L.config},add:function(a,b){"undefined"==typeof L.fn[a]&&(L.fn[a]=b)},get:function(a){return L.fn[a]},addEvent:function(a,b){"undefined"==typeof L.events[a]&&(L.events[a]=b)},getEvent:function(a){return L.events[a]},ajax:function(a){I(a)}}}"function"==typeof define&&define.amd?define(["jquery"],function(c){return b(a,c),purple}):b(a,jQuery)}(window);