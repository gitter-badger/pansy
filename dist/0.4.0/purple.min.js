/**
 * purple.js v0.4.0 http://purple.heineiuo.com
 * @author Hansel http://heineiuo.com
 */
!function(a){function b(a,b){function c(b){for(name in O.machineNames)t(O.machines[name]);O={},O={timestamp:Date.now(),htmlsuffix:b.htmlsuffix||null,htmlpath:b.htmlpath||"/html/",debug:b.debug||!1,errorHandle:b.errorHandle||E,ajaxErrorHandle:b.ajaxErrorHandle||M,ajaxFailHandle:b.ajaxFailHandle||N,progressHandle:b.progressHandle||F,progressShow:b.progressShow||!1,autoCallback:b.autoCallback||G,listenA:b.listenA||!1,listenP:b.listenP||!1,pending:!1,error:!1,ua:null,jack_id:1,jacks:{},html:{},prevURL:null,eventArray:[],machineNames:[],machines:{},machineMaster:null,events:{},fn:{},scope:new RegExp("^"+(b.scope||location.origin)),config:b},O.debug&&(P.debug=D),O.listenA&&H({eventItem:[document,"click","a",J]}),O.listenP&&H({eventItem:[a,"popstate",K]})}function d(a,b,c){f(a);var d=c||30,e=new Date;e.setTime(e.getTime()+24*d*60*60*1e3);var g="/";document.cookie=a+"="+escape(b)+";expires="+e.toGMTString()+";path="+g}function e(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function f(a){var b=new Date;b.setTime(b.getTime()-1);var c=e(a);null!=c&&(document.cookie=a+"="+c+";expires="+b.toGMTString())}function g(a){return"undefined"!=typeof a}function h(a){return"undefined"==typeof a}function j(a){return null===a||""===a}function k(a){var b=0;for(i in a)b++;return b}function l(a,b){function c(a,b){if(a.length!=b.length)return!1;for(var c=b.length,d=0;c>d;d++)if(a[d]!==b[d])return!1;return!0}for(var d=b.length,e=0;d>e;e++)if("object"==typeof b[e]){if(c(b[e],a))return!0}else if(b[e]==a)return!0;return!1}function m(a,b){if(a.length!=b.length)return!1;for(var c=b.length,d=0;c>d;d++)if(a[d]!==b[d])return!1;return!0}function n(a,b){for(var c=0;c<a.length;c++)a[c]==b&&(a.splice(c,1),c--);return a}function o(a,b){for(var c=0;c<a.length;c++)m(a[c],b)&&(a.splice(c,1),c--);return a}function p(a){return JSON.parse(JSON.stringify(a))}function q(a){function b(a,d){Object.keys(a).forEach(function(e){var f=[];a[e]instanceof Object&&!(a[e]instanceof Array)&&(d.length&&(f=d.concat()),f.push(e),c.push(f),b(a[e],f))})}var c=[];return b(a,[]),c}function r(a){function b(a){Object.keys(a).forEach(function(d){a[d]instanceof Object&&!(a[d]instanceof Array)&&(c.push(d),b(a[d]))})}var c=[];return b(a),c}function s(a){function b(a){return a.parentNode||a.parentElement}function c(a){return/state[a-z]+/.test(a)}var d=b(a);if("HTML"==d.nodeName)return!1;var e=d.id;return""!=e&&c(e)?e.substring(5):s(d)}function t(a){for(var c=0;c<a.eventArray.length;c++){var d=a.eventArray[c];b(d[0]).off(d[1],d[2],d[3])}a.eventArray=[]}function u(a){var b=document.createElement("a");b.href=a;var c=b.pathname||"/"+b.pathname,d={href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:c.replace(/^([^\/])/,"/$1"),pathnames:n(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,searches:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:n(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},e=String();if(e+="/"+d.pathnames.join("/"),k(d.searches)>0){e+=String("?");for(x in d.searches)e+=x+"=",e+="undefined"!=typeof d.searches[x]?d.searches[x]:"",e+="&";e=e.substring(0,e.length-1)}if(d.hashes.length>0){e+="#";for(var f=0;f<d.hashes.length;f++)e+=f<d.hashes.length-1?d.hashes[f]+String("/"):d.hashes[f]}return d.parsedURL=e,d}function v(a,c){function d(a){var b=document.createElement("div");return b.innerHTML=a,b=1==b.childNodes.length?b.childNodes[0]:b}return"undefined"!=typeof c?O.html[a]=d(c):g(O.html[a])||b.ajax({url:O.htmlpath+"/"+a+".html",type:"GET",dataType:"html",async:!1}).done(function(b){O.html[a]=d(b)}).fail(function(a){O.debug&&console.log(a)}),O.html[a]}function w(a,c){function d(a){for(var c=b(O.html[a]).find("[data-jack]"),d=0;d<c.length;d++){var e=c.eq(d),f=e.attr("data-jack");"undefined"==typeof O.jacks[f]&&(O.jack_id++,O.jacks[f]={id:"ppjack"+String(O.jack_id),ready:!1}),"string"==typeof e.attr("id")&&(O.jacks[f].id=e.attr("id")),e.attr("id",O.jacks[f].id),O.debug||e.attr("data-jack",null)}return""!=O.html[a].id?O.jacks[a].id=O.html[a].id:O.html[a].id=O.jacks[a].id,O.html[a]}return O.jacks[a].ready||("undefined"==typeof c?v(a):v(a,c),d(a),O.jacks[a].ready=!0),O.html[a]}function y(a){O.machineNames.push(a.machine);var b={prevDiffState:null,states:{},stateNow:null,statePrev:null,stateNames:[],stateReadyNames:[],eventArray:[],url:null};g(a.routerCondition)?(b.routerCondition=a.routerCondition,b.needCondition=!0):b.needCondition=!1,g(a.notFoundHandle)&&(b.notFoundHandle=a.notFoundHandle),a.master&&(O.machineMaster=a.machine),O.machines[a.machine]=b}function z(a){if(h(O.machines[a.machine]))return!1;for(var b=a.machine,c=a.name,d=c instanceof RegExp?c:new RegExp("^\\/"+c.join("\\/")+"$"),e=a.jack||{},f=a.events||[],i=a.callback||function(){return!0},j=q(e),k=r(e),l=0;l<k.length;l++)"undefined"==typeof O.jacks[k[l]]&&(O.jack_id++,O.jacks[k[l]]={id:"ppjack"+String(O.jack_id),ready:!1});var m=O.machines[b];m.stateNames.push(d);var n={name:c,jack:e,jackarr:j,events:f,callback:i,url:null,jackReady:!1};n.needCondition=g(a.needCondition)?a.needCondition:m.needCondition,g(a.routerCondition)&&(n.needCondition=!0,n.routerCondition=a.routerCondition),O.machines[b].states[d]=n}function A(a){if(O.pending)return!1;if(h(O.machines[a.machine]))return!1;var b=a.href||location.href,c=u(b);B({machine:a.machine,transport:c,type:a.type||"push",clearCache:a.clearCache||!1})}function B(a){function c(a,b,d,e,f){if(a>=O.machines[b].stateNames.length){if(0==d.length)return f(),!1;b=d.shift(),a=0}return a<O.machines[b].stateNames.length&&O.machines[b].stateNames[a].test(e)?(f(b,O.machines[b].stateNames[a]),!1):(a++,void c(a,b,d,e,f))}function d(a,c){if("undefined"==typeof a)P.progress(100),E("ERR_ROUTER_404",j.parsedURL),g(O.machines[O.machineMaster].notFoundHandle)&&O.machines[O.machineMaster].notFoundHandle();else{var d=O.machines[a],e=d.states[c];if(e.needCondition){var f=g(e.routerCondition)?e.routerCondition:d.routerCondition;if(!f(j))return P.progress(100),O.pending=!1,!1}if(O.pending=!0,j.jackReady=!0,j.callReady=!0,i?(j.jackReady=!1,j.callReady=!1):e.jackReady?j.parsedURL!=e.url&&(j.callReady=!1):(j.jackReady=!1,j.callReady=!1),j.prevURL=d.url,d.url=j.parsedURL,j.statePrevURL=e.url,e.url=j.parsedURL,O.pending=!1,null==d.prevDiffState?d.prevDiffState=c:d.prevDiffState.toString()!=c.toString()&&(j.prevDiffStateURL=d.states[d.prevDiffState].url,d.prevDiffState=c),O.machineMaster==a)switch(h){case"push":history.pushState("data","title",j.parsedURL);break;case"replace":history.replaceState("data","title",j.parsedURL)}P.progress(30),C({machine:a,stateName:c},function(){e.jackReady=!0,P.progress(50),O.autoCallback(),e.callback(j)}),O.debug&&b("#state"+a).attr({"data-router":j.parsedURL})}}P.progress(5);var e=a.machine,f=n(p(O.machineNames),e),h=a.type,i=a.clearCache,j=a.transport;P.progress(15),c(0,e,f,j.pathname,d)}function C(a,c){function d(a){if("undefined"!=typeof O.jacks[a[a.length-1]].loaded)f(a);else{var c=g(a[a.length-1]),d=w(a[a.length-1]);if(null==c){var e=1==a.length?n:g(a[a.length-2]);b(e).append(d)}else b(c).after(d),b(c).remove()}O.jacks[a[a.length-1]].loaded=!0}function e(a){g(a[a.length-1]).style.display="none"}function f(a){g(a[a.length-1]).style.display="block"}function g(a){return document.getElementById(O.jacks[a].id)}var h=a.machine,i=O.machines[h],k=a.stateName,m=i.states[k],n=document.getElementById("state"+h);if(null==n&&(n=document.createElement("div"),n.id="state"+h,document.body.appendChild(n)),j(i.stateNow))for(var o=0;o<m.jackarr.length;o++)d(m.jackarr[o]);else{var p=i.states[i.stateNow];p.jackarr=q(p.jack),t(i);for(var o=0;o<p.jackarr.length;o++)l(p.jackarr[o],m.jackarr)||e(p.jackarr[o]);for(var o=0;o<m.jackarr.length;o++)m.jackReady?f(m.jackarr[o]):l(m.jackarr[o],p.jackarr)?f(m.jackarr[o]):d(m.jackarr[o])}P.progress(40),i.statePrev=i.stateNow,i.stateNow=k;for(var o=0;o<m.events.length;o++)H({machine:h,eventItem:m.events[o]});c()}function D(a){"undefined"==typeof a&&console.log(O)}function E(a,b){if(O.debug){var a=a||"",b=b||"";console.error(a+": "+b)}}function F(a){function c(a){b("#npop").length||b("body").append(b('<div id="npop"><style>#npop{z-index:1000000;position:fixed;top:0;right:0;left:0;height:4px}#npop .power{position:absolute;top:0;bottom:0;left:0;background-color:rgb(85,185,215);transition:all .5s ease}</style><div class="power"></div></div>')),b("#npop .power").css({width:a+"%"})}function d(){b("#npop").remove()}var a=Number(a)||0;switch(a=a>100?100:a,a=0>a?0:a){case 100:c(100),setTimeout(d,500);break;default:c(a)}}function G(){}function H(a){var c=a.eventItem,d="undefined"!=typeof a.machine?O.machines[a.machine].eventArray:O.eventArray;if(!l(c,d))switch(d.push(c),c.length){case 3:b(c[0]).on(c[1],c[2]);break;case 4:b(c[0]).on(c[1],c[2],c[3])}}function I(a){var c=a.eventItem,d="undefined"!=typeof a.machine?O.machines[a.machine].eventArray:O.eventArray;if(l(c,d)){switch(c.length){case 3:b(c[0]).off(c[1],c[2]);break;case 4:b(c[0]).off(c[1],c[2],c[3])}d=o(d,c)}}function J(c){var d=b(c.target).closest("a"),e=d.attr("href")||0,f=d.attr("target")||0;if(0!=e&&0==f){var g=u(e);if(O.scope.test(g.href)){var h=s(d[0]);0!=h&&(c&&c.preventDefault?c.preventDefault():a.event.returnValue=!1,B({machine:h,transport:g,type:"push",clearCache:!1}))}}}function K(){var a=u(location.href);O.scope.test(a.href)&&B({machine:O.machineMaster,transport:a,type:"replace",clearCache:!1})}function L(a){var c=a.url||O.apipath,d=a.callback||function(){},e=a.data||{},f=a.type||"POST",g=a.dataType||"json";b.ajax({url:c,type:f,dataType:g,data:e}).done(function(b){O.debug&&console.log(b),"undefined"==typeof b.error?d(b):"undefined"!=typeof a.error?a.error(b,function(a){a&&O.ajaxErrorHandle(b)}):O.ajaxErrorHandle(b)}).fail(function(){"undefined"!=typeof a.fail?a.fail(e,function(a){a&&O.ajaxFailHandle(e)}):O.ajaxFailHandle(e)})}function M(a){O.debug&&console.log(a)}function N(a){O.debug&&console.log(a)}var O={},P=a.purple={init:function(a){c(a)},machine:function(a){y(a)},newMachine:function(a){y(a)},html:function(a,b){return v(a,b)},on:function(a){H(a)},off:function(a){I(a)},router:function(a){A(a)},route:function(a){A(a)},define:function(a){z(a)},progress:function(a){O.progressShow&&F(a)},parseURL:function(a){return u(a)},getConfig:function(){return O.config},add:function(a,b){"undefined"==typeof O.fn[a]&&(O.fn[a]=b)},set:function(a,b){"undefined"==typeof O.fn[a]&&(O.fn[a]=b)},get:function(a){return O.fn[a]},addEvent:function(a,b){"undefined"==typeof O.events[a]&&(O.events[a]=b)},getEvent:function(a){return O.events[a]},ajax:function(a){L(a)},setCookie:d,getCookie:e,removeCookie:f}}"function"==typeof define&&define.amd?define(["jquery"],function(c){return b(a,c),purple}):b(a,jQuery)}(window);