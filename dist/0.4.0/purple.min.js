/**
 * purple.js v0.4.0 http://purple.heineiuo.com
 * @author Hansel http://heineiuo.com
 */
!function(a){function b(a,b){function c(a){var b=0;for(i in a)b++;return b}function d(a,b){for(var c=b.length,d=0;c>d;d++)if("object"==typeof b[d]){if(e(b[d],a))return!0}else if(b[d]==a)return!0;return!1}function e(a,b){if(a.length!=b.length)return!1;for(var c=b.length,d=0;c>d;d++)if(a[d]!==b[d])return!1;return!0}function f(a,b){for(var c=0;c<a.length;c++)a[c]==b&&(a.splice(c,1),c--);return a}function g(a,b){for(var c=0;c<a.length;c++)e(a[c],b)&&(a.splice(c,1),c--);return a}function h(a){return JSON.parse(JSON.stringify(a))}function j(a){function b(a,d){Object.keys(a).forEach(function(e){var f=[];a[e]instanceof Object&&!(a[e]instanceof Array)&&(d.length&&(f=d.concat()),f.push(e),c.push(f),b(a[e],f))})}var c=[];return b(a,[]),c}function k(a){function b(a){Object.keys(a).forEach(function(d){a[d]instanceof Object&&!(a[d]instanceof Array)&&(c.push(d),b(a[d]))})}var c=[];return b(a),c}function l(a){for(var c=0;c<a.eventArray.length;c++){var d=a.eventArray[c];b(d[0]).off(d[1],d[2],d[3])}a.eventArray=[]}function m(a){function b(a){return a.parentNode||a.parentElement}function c(a){return/state[a-z]+/.test(a)}var d=b(a);if("HTML"==d.nodeName)return!1;var e=d.id;return""!=e&&c(e)?e.substring(5):m(d)}function n(a){return"undefined"!=typeof a}function o(a){return"undefined"==typeof a}function p(a){return null===a||""===a}function q(a){var b=document.createElement("a");b.href=a;var d=b.pathname||"/"+b.pathname,e={href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:d.replace(/^([^\/])/,"/$1"),pathnames:f(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,searches:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:f(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},g=String();if(g+="/"+e.pathnames.join("/"),c(e.searches)>0){g+=String("?");for(x in e.searches)g+=x+"=",g+="undefined"!=typeof e.searches[x]?e.searches[x]:"",g+="&";g=g.substring(0,g.length-1)}if(e.hashes.length>0){g+="#";for(var h=0;h<e.hashes.length;h++)g+=h<e.hashes.length-1?e.hashes[h]+String("/"):e.hashes[h]}return e.parsedURL=g,e}function r(a){var c=a.url||O.apipath,d=a.callback||function(){},e=a.data||{},f=a.type||"POST",g=a.dataType||"json";b.ajax({url:c,type:f,dataType:g,data:e}).done(function(b){O.debug&&console.log(b),"undefined"==typeof b.error?d(b):"undefined"!=typeof a.error?a.error(b,function(a){a&&O.ajaxErrorHandle(b)}):O.ajaxErrorHandle(b)}).fail(function(){"undefined"!=typeof a.fail?a.fail(e,function(a){a&&O.ajaxFailHandle(e)}):O.ajaxFailHandle(e)})}function s(a){O.debug&&console.log(a)}function t(a){O.debug&&console.log(a)}function u(a,c){function e(a){if("undefined"!=typeof O.jacks[a[a.length-1]].loaded)g(a);else{var c=h(a[a.length-1]),d=H(a[a.length-1]);if(null==c){var e=1==a.length?o:h(a[a.length-2]);b(e).append(d)}else b(c).after(d),b(c).remove()}O.jacks[a[a.length-1]].loaded=!0}function f(a){h(a[a.length-1]).style.display="none"}function g(a){h(a[a.length-1]).style.display="block"}function h(a){return document.getElementById(O.jacks[a].id)}var i=a.machine,k=O.machines[i],m=a.stateName,n=k.states[m],o=document.getElementById("state"+i);if(null==o&&(o=document.createElement("div"),o.id="state"+i,document.body.appendChild(o)),p(k.stateNow))for(var q=0;q<n.jackarr.length;q++)e(n.jackarr[q]);else{var r=k.states[k.stateNow];r.jackarr=j(r.jack),l(k);for(var q=0;q<r.jackarr.length;q++)d(r.jackarr[q],n.jackarr)||f(r.jackarr[q]);for(var q=0;q<n.jackarr.length;q++)n.jackReady?g(n.jackarr[q]):d(n.jackarr[q],r.jackarr)?g(n.jackarr[q]):e(n.jackarr[q])}P.progress(40),k.statePrev=k.stateNow,k.stateNow=m;for(var q=0;q<n.events.length;q++)K({machine:i,eventItem:n.events[q]});c()}function v(a,b,c){y(a);var d=c||30,e=new Date;e.setTime(e.getTime()+24*d*60*60*1e3);var f="/";document.cookie=a+"="+escape(b)+";expires="+e.toGMTString()+";path="+f}function w(a){var b=document.cookie.match(new RegExp("(^| )"+a+"=([^;]*)(;|$)"));return null!=b?unescape(b[2]):null}function y(a){var b=new Date;b.setTime(b.getTime()-1);var c=w(a);null!=c&&(document.cookie=a+"="+c+";expires="+b.toGMTString())}function z(a){"undefined"==typeof a&&console.log(O)}function A(a,b){if(O.debug){var a=a||"",b=b||"";console.error(a+": "+b)}}function B(a){function c(a){b("#npop").length||b("body").append(b('<div id="npop"><style>#npop{z-index:1000000;position:fixed;top:0;right:0;left:0;height:4px}#npop .power{position:absolute;top:0;bottom:0;left:0;background-color:rgb(85,185,215);transition:all .5s ease}</style><div class="power"></div></div>')),b("#npop .power").css({width:a+"%"})}function d(){b("#npop").remove()}var a=Number(a)||0;switch(a=a>100?100:a,a=0>a?0:a){case 100:c(100),setTimeout(d,500);break;default:c(a)}}function C(){}function D(a){if(o(O.machines[a.machine]))return!1;for(var b=a.machine,c=a.name,d=c instanceof RegExp?c:new RegExp("^\\/"+c.join("\\/")+"$"),e=a.jack||{},f=a.events||[],g=a.callback||function(){return!0},h=j(e),i=k(e),l=0;l<i.length;l++)"undefined"==typeof O.jacks[i[l]]&&(O.jack_id++,O.jacks[i[l]]={id:"ppjack"+String(O.jack_id),ready:!1});var m=O.machines[b];m.stateNames.push(d);var p={name:c,jack:e,jackarr:h,events:f,callback:g,url:null,jackReady:!1};p.needCondition=n(a.needCondition)?a.needCondition:m.needCondition,n(a.routerCondition)&&(p.needCondition=!0,p.routerCondition=a.routerCondition),O.machines[b].states[d]=p}function E(c){var d=b(c.target).closest("a"),e=d.attr("href")||0,f=d.attr("target")||0;if(0!=e&&0==f){var g=q(e);if(O.scope.test(g.href)){var h=m(d[0]);0!=h&&(c&&c.preventDefault?c.preventDefault():a.event.returnValue=!1,N({machine:h,transport:g,type:"push",clearCache:!1}))}}}function F(){var a=q(location.href);O.scope.test(a.href)&&N({machine:O.machineMaster,transport:a,type:"replace",clearCache:!1})}function G(a,c){function d(a){var b=document.createElement("div");return b.innerHTML=a,b=1==b.childNodes.length?b.childNodes[0]:b}return"undefined"!=typeof c?O.html[a]=d(c):n(O.html[a])||b.ajax({url:O.htmlpath+"/"+a+".html",type:"GET",dataType:"html",async:!1}).done(function(b){O.html[a]=d(b)}).fail(function(a){O.debug&&console.log(a)}),O.html[a]}function H(a,c){function d(a){for(var c=b(O.html[a]).find("[data-jack]"),d=0;d<c.length;d++){var e=c.eq(d),f=e.attr("data-jack");"undefined"==typeof O.jacks[f]&&(O.jack_id++,O.jacks[f]={id:"ppjack"+String(O.jack_id),ready:!1}),"string"==typeof e.attr("id")&&(O.jacks[f].id=e.attr("id")),e.attr("id",O.jacks[f].id),O.debug||e.attr("data-jack",null)}return""!=O.html[a].id?O.jacks[a].id=O.html[a].id:O.html[a].id=O.jacks[a].id,O.html[a]}return O.jacks[a].ready||("undefined"==typeof c?G(a):G(a,c),d(a),O.jacks[a].ready=!0),O.html[a]}function I(b){for(name in O.machineNames)l(O.machines[name]);O={},O={timestamp:Date.now(),htmlsuffix:b.htmlsuffix||null,htmlpath:b.htmlpath||"/html/",debug:b.debug||!1,errorHandle:b.errorHandle||A,ajaxErrorHandle:b.ajaxErrorHandle||s,ajaxFailHandle:b.ajaxFailHandle||t,progressHandle:b.progressHandle||B,progressShow:b.progressShow||!1,autoCallback:b.autoCallback||C,listenA:b.listenA||!1,listenP:b.listenP||!1,pending:!1,error:!1,ua:null,jack_id:1,jacks:{},html:{},prevURL:null,eventArray:[],machineNames:[],machines:{},machineMaster:null,events:{},fn:{},scope:new RegExp("^"+(b.scope||location.origin)),config:b},O.debug&&(P.debug=z),O.listenA&&K({eventItem:[document,"click","a",E]}),O.listenP&&K({eventItem:[a,"popstate",F]})}function J(a){O.machineNames.push(a.machine);var b={prevDiffState:null,states:{},stateNow:null,statePrev:null,stateNames:[],stateReadyNames:[],eventArray:[],url:null};n(a.routerCondition)?(b.routerCondition=a.routerCondition,b.needCondition=!0):b.needCondition=!1,n(a.notFoundHandle)&&(b.notFoundHandle=a.notFoundHandle),a.master&&(O.machineMaster=a.machine),O.machines[a.machine]=b}function K(a){var c=a.eventItem,e="undefined"!=typeof a.machine?O.machines[a.machine].eventArray:O.eventArray;if(!d(c,e))switch(e.push(c),c.length){case 3:b(c[0]).on(c[1],c[2]);break;case 4:b(c[0]).on(c[1],c[2],c[3])}}function L(a){var c=a.eventItem,e="undefined"!=typeof a.machine?O.machines[a.machine].eventArray:O.eventArray;if(d(c,e)){switch(c.length){case 3:b(c[0]).off(c[1],c[2]);break;case 4:b(c[0]).off(c[1],c[2],c[3])}e=g(e,c)}}function M(a){if(O.pending)return!1;if(o(O.machines[a.machine]))return!1;var b=a.href||location.href,c=q(b);N({machine:a.machine,transport:c,type:a.type||"push",clearCache:a.clearCache||!1})}function N(a){function c(a,b,d,e,f){if(a>=O.machines[b].stateNames.length){if(0==d.length)return f(),!1;b=d.shift(),a=0}return a<O.machines[b].stateNames.length&&O.machines[b].stateNames[a].test(e)?(f(b,O.machines[b].stateNames[a]),!1):(a++,void c(a,b,d,e,f))}function d(a,c){if("undefined"==typeof a)P.progress(100),A("ERR_ROUTER_404",k.parsedURL),n(O.machines[O.machineMaster].notFoundHandle)&&O.machines[O.machineMaster].notFoundHandle();else{var d=O.machines[a],e=d.states[c];if(e.needCondition){var f=n(e.routerCondition)?e.routerCondition:d.routerCondition;if(!f(k))return P.progress(100),O.pending=!1,!1}if(O.pending=!0,k.jackReady=!0,k.callReady=!0,j?(k.jackReady=!1,k.callReady=!1):e.jackReady?k.parsedURL!=e.url&&(k.callReady=!1):(k.jackReady=!1,k.callReady=!1),k.prevURL=d.url,d.url=k.parsedURL,k.statePrevURL=e.url,e.url=k.parsedURL,O.pending=!1,null==d.prevDiffState?d.prevDiffState=c:d.prevDiffState.toString()!=c.toString()&&(k.prevDiffStateURL=d.states[d.prevDiffState].url,d.prevDiffState=c),O.machineMaster==a)switch(i){case"push":history.pushState("data","title",k.parsedURL);break;case"replace":history.replaceState("data","title",k.parsedURL)}P.progress(30),u({machine:a,stateName:c},function(){e.jackReady=!0,P.progress(50),O.autoCallback(),e.callback(k)}),O.debug&&b("#state"+a).attr({"data-router":k.parsedURL})}}P.progress(5);var e=a.machine,g=f(h(O.machineNames),e),i=a.type,j=a.clearCache,k=a.transport;P.progress(15),c(0,e,g,k.pathname,d)}var O={},P=a.purple={init:function(a){I(a)},machine:function(a){J(a)},newMachine:function(a){J(a)},html:function(a,b){return G(a,b)},on:function(a){K(a)},off:function(a){L(a)},router:function(a){M(a)},route:function(a){M(a)},define:function(a){D(a)},progress:function(a){O.progressShow&&B(a)},parseURL:function(a){return q(a)},getConfig:function(){return O.config},add:function(a,b){"undefined"==typeof O.fn[a]&&(O.fn[a]=b)},set:function(a,b){"undefined"==typeof O.fn[a]&&(O.fn[a]=b)},get:function(a){return O.fn[a]},addEvent:function(a,b){"undefined"==typeof O.events[a]&&(O.events[a]=b)},getEvent:function(a){return O.events[a]},ajax:function(a){r(a)},setCookie:v,getCookie:w,removeCookie:y}}"function"==typeof define&&define.amd?define(["jquery"],function(c){return b(a,c),purple}):b(a,jQuery)}(window);