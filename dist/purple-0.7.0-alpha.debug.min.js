/*! PURPLE.js (DEBUG) v0.7.0-alpha 2015-10-18 */
!function(a){function b(){function a(a,b,c){return"undefined"!=typeof this.disabled?c():(this.disabled=!0,l.conf.spa?(console.log("开启监听anchor点击"),document.addEventListener("click",function(a){function b(a,c){a==document.body||null==a?c("notfound"):"A"==a.nodeName?"undefined"==typeof a.attributes.href?c("err"):c(null,a.attributes.href.value):b(a.parentNode,c)}b(a.target,function(b,c){return console.warn(b),b?!1:void("#"==c.substr(0,1)?console.info("HASH_MODE"):(a.preventDefault(),console.info("获取成功,开始跳转"),l.app.go(c,"push")))})},!1),void c()):c())}function b(a,b,c){return"undefined"!=typeof this.disabled?c():(this.disabled=!0,l.conf.spa?(console.log("开启监听浏览器popstate状态"),window.addEventListener("popstate",function(a){var b=l.state.curUrl,c=location.href,e=d(b),f=d(c);e.pathname==f.pathname&&e.search==f.search?console.log("HASH_CHNAGED"):k(conf.name).go(location.href)},!1),void c()):c())}function c(a){try{return 4==a.toString().match(/[A-Z0-9a-z,(\s]*\)/)[0].split(",").length}catch(b){return!1}}function d(a){var b=document.createElement("a");b.href=a;var c=b.pathname||"/"+b.pathname,d={rawUrl:b.href,href:b.href,origin:b.origin,source:a,protocol:b.protocol.replace(":",""),hostname:b.hostname,port:b.port,relative:(b.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:c.replace(/^([^\/])/,"/$1"),pathnames:j(b.pathname.replace(/^\//,"").split("/"),""),search:b.search,query:function(){for(var a,c={},d=b.search.replace(/^\?/,"").split("&"),e=d.length,f=0;e>f;f++)d[f]&&(a=d[f].split("="),c[a[0]]=a[1]);return c}(),hash:b.hash.replace("#",""),hashes:j(b.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(b.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},e="/"+d.pathnames.join("/");if(!g(d.searches)){e+=String("?");for(var f in d.searches)d.searches.hasOwnProperty(f)&&(e+=f+"=",e+="undefined"!=typeof d.searches[f]?d.searches[f]:"",e+="&");e=e.substring(0,e.length-1)}if(d.hashes.length>0){e+="#";for(var h=0;h<d.hashes.length;h++)e+=h<d.hashes.length-1?d.hashes[h]+String("/"):d.hashes[h]}return d.params=d.pathnames,d.parsedURL=e,d.parsedUrl=e,d}function e(a,b){try{return a.filterPath.match(b)[0]==a.filterPath}catch(c){return!1}}function f(a,b){var c=a.length;if("function"!=typeof b)throw new TypeError;for(var d=0;c>d;d++)d in a&&b.call(arguments[1],a[d],d,a)}function g(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function h(a,b){var c={};for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&"function"==typeof b&&(c[d]=b.call(a,a[d],d,a));return c}function i(){var a={},b=Array.prototype.slice.call(arguments,0);return f(b,function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function j(a,b){var c=[];return f(a,function(a){a!==b&&c.push(a)}),c}function k(){return l.init?l.app:(l.conf={origin:location.protocol+"//"+location.hostname+(""==location.port?"":":"+location.port),timeout:6e4,routeByQuery:!1,routeQuery:"route",routeScope:"",spa:!1},l.state={complete:!0,prevUrl:null,curUrl:location.href,errorStack:null},l.stack=[],l.app={},l.app.set=function(a,b){l.conf[a]=b},l.app.get=function(a){return"undefined"!=typeof a?l.conf[a]:l.conf},l.app.use=function(){if(1==arguments.length)if("function"==typeof arguments[0]){var a={fn:arguments[0]};a.isErrorHandle=c(a.fn),l.stack.push(a)}else if(arguments[0]instanceof Array){var b=arguments[0];h(b,function(a,b){"function"==typeof a?l.app.use(a):a instanceof Array&&2==a.length?l.app.use(a[0],a[1]):console.warn("use参数有误")})}else arguments[0]instanceof Object&&arguments[0].__stack instanceof Array?l.app.use(arguments[0].__stack):console.warn("use参数有误");else if(2==arguments.length){var d=arguments[0],a={fn:arguments[1]};d instanceof Array?d=new RegExp("(^"+d.join("$)|(^")+"$)"):"string"==typeof d&&(d=new RegExp("^"+d+"$")),!d instanceof RegExp&&console.error("route参数错误: "+d),a.path=d,a.isErrorHandle=c(a.fn),l.stack.push(a)}},l.app.go=function(a,b){if(!l.state.complete)return!1;l.state.complete=!1;var c=d(a);if(c.origin!=l.conf.origin&&location.replace(a),l.conf.routeByQuery)var f=c.query[l.conf.routeQuery]||"/";else var f=c.pathname.substr(l.conf.routeScope.length)||"/";var g=setTimeout(function(){j.end(),console.warn("超时")},l.conf.timeout),h=i(c,{routed:!1,expire:Date.now()+l.conf.timeout,conf:l.conf,state:l.state,filterPath:f,rawUrl:a,historyStateType:b||"push"}),j={end:function(){l.state.complete=!0,l.state.errorStack=null,clearTimeout(g),console.info("请求结束"),l.conf.spa&&("replace"==h.historyStateType?history.replaceState("data","title",h.parsedURL):history.pushState("data","title",h.parsedURL))},redirect:function(a){this.end(),l.app.go(a,"replace")}},k=-1,m=function(a){function b(){l.stack[k].isErrorHandle?l.stack[k].fn(l.state.errorStack,h,j,m):l.stack[k].fn(h,j,m)}k++,"undefined"!=typeof a&&(l.state.errorStack||(l.state.errorStack=[]),l.state.errorStack.push(a)),k>=l.stack.length?(l.state.errorStack&&console.error(l.state.errorStack),h.routed||console.error("404 not found"),j.end()):"undefined"!=typeof l.stack[k].disabled?m():"undefined"!=typeof l.stack[k].path?e(h,l.stack[k].path)?(h.routed=!0,b()):m():b()};m()},l.app.use(b),l.app.use(a),l.init=!0,l.app)}var l={init:!1};return k.Router=function(){var a=[];return{__stack:a,use:function(b){a.push(b)},route:function(b){return{get:function(){var c=Array.prototype.slice.call(arguments,0);h(c,function(c,d){a.push([b,c])})}}}}},k.Controller=function(){var a={};return function(b,c){var d="undefined"!=typeof a[b];return"function"==typeof c?(d&&console.warn("controller has exits, but this new controller will be registered: "+b),a[b]=c):d||(console.warn("controller lost fn param, but it still run: "+b),a[b]=function(a,b,c){c()}),a[b]}},k}"function"==typeof define&&define.amd?define(function(){return b()}):a.purple=b()}(this);