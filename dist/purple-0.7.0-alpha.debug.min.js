/*! PURPLE.js (DEBUG) v0.7.0-alpha 2015-10-25
 * YOU CANNOT USE THIS FILE ON ANY OTHER PLATFORM.*/
!function(a){function b(){function a(a,b,c){return"undefined"!=typeof this.disabled?c():(this.disabled=!0,k.conf.spa?(console.info("监听anchor点击: 开启"),document.addEventListener("click",function(a){function b(a){a!=document.body&&null!=a&&("A"==a.nodeName?"undefined"!=typeof a.attributes.href&&c(a.attributes.href.value):b(a.parentNode,callback))}function c(b){"#"!=b.substr(0,1)&&e(location.href).origin()==e(b).origin()&&e(location.href).beforeHash()!=e(b).beforeHash()&&(a.preventDefault(),console.info("开始解析:"+b),k.app.go(b,"push"))}b(a.target)},!1),void c()):c())}function b(a,b,c){return"undefined"!=typeof this.disabled?c():(this.disabled=!0,k.conf.spa?(console.info("监听浏览器popstate状态: 开启"),window.addEventListener("popstate",function(a){e(k.state.curUrl).beforeHash()!=e(location.href).beforeHash()&&k.app.go(location.href)},!1),void c()):c())}function c(a){try{return 4==a.toString().match(/[A-Z0-9a-z,(\s]*\)/)[0].split(",").length}catch(b){return!1}}function d(a,b){try{return a.filterPath.match(b)[0]==a.filterPath}catch(c){return!1}}function e(a){function b(){return g.href.replace(/#.*/,"")}function c(){var a=g.pathname||"/"+g.pathname;return a.replace(/^([^\/])/,"/$1")}function d(){return i(g.pathname.replace(/^\//,"").split("/"),"")}function e(){for(var a={},b=g.search.replace(/^\?/,"").split("&"),c=b.length,d=0;c>d;d++)if(b[d]){var e=b[d].split("=");a[e[0]]=e[1]}return a}function f(){if("undefined"!=typeof g.origin)return g.origin;var a=g.protocol+"//"+g.hostname;return""==g.port?a:"80"==g.port&&"http:"==g.protocol?a:"443"==g.port&&"https"==g.protocol?a:a+=":"+g.port}var g=document.createElement("a");return g.href=a,{href:g.href,hash:g.hash,port:g.port,protocol:g.protocol,pathname:c,parmas:d,query:e,origin:f,beforeHash:b,all:function(){return{port:g.port,protocol:g.protocol,hostname:g.hostname,pathname:c(),parmas:d(),query:e(),origin:f()}}}}function f(a,b){var c=a.length;if("function"!=typeof b)throw new TypeError;for(var d=0;c>d;d++)d in a&&b.call(arguments[1],a[d],d,a)}function g(a,b){var c={};for(var d in a)Object.prototype.hasOwnProperty.call(a,d)&&"function"==typeof b&&(c[d]=b.call(a,a[d],d,a));return c}function h(){var a={},b=Array.prototype.slice.call(arguments,0);return f(b,function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function i(a,b){var c=[];return f(a,function(a){a!==b&&c.push(a)}),c}function j(){return k.init?k.app:(k.conf={timeout:6e4,routeByQuery:!1,routeQuery:"route",routeScope:"",spa:!1},k.state={complete:!0,prevUrl:null,curUrl:location.href,errorStack:null},k.stack=[],k.app={},k.app.set=function(a,b){k.conf[a]=b},k.app.get=function(a){return"undefined"!=typeof a?k.conf[a]:k.conf},k.app.use=function(){if(1==arguments.length)if("function"==typeof arguments[0]){var a={fn:arguments[0]};a.isErrorHandle=c(a.fn),k.stack.push(a)}else if(arguments[0]instanceof Array){var b=arguments[0];g(b,function(a,b){"function"==typeof a?k.app.use(a):a instanceof Array&&2==a.length?k.app.use(a[0],a[1]):console.warn("use参数有误")})}else arguments[0]instanceof Object&&arguments[0].__stack instanceof Array?k.app.use(arguments[0].__stack):console.warn("use参数有误");else if(2==arguments.length){var d=arguments[0],a={fn:arguments[1]};d instanceof Array?d=new RegExp("(^"+d.join("$)|(^")+"$)"):"string"==typeof d&&(d=new RegExp("^"+d+"$")),!d instanceof RegExp&&console.error("route参数错误: "+d),a.path=d,a.isErrorHandle=c(a.fn),k.stack.push(a)}},k.app.go=function(a,b){if(!k.state.complete)return!1;k.state.complete=!1;var c=e(a).all();if(k.conf.routeByQuery)var f=c.query[k.conf.routeQuery]||"/";else if(c.pathname.match(new RegExp("^"+k.conf.routeScope)))var f=c.pathname.substr(k.conf.routeScope.length)||"/";else var f="/";console.info("请求地址: "+f);var g=setTimeout(function(){j.end(),console.warn("超时")},k.conf.timeout),i=h(c,{routed:!1,expire:Date.now()+k.conf.timeout,conf:k.conf,state:k.state,filterPath:f,rawUrl:a,historyStateType:b||"push"}),j={end:function(){k.state.complete=!0,k.state.errorStack=null,clearTimeout(g),console.info("请求结束"),k.conf.spa&&("replace"==i.historyStateType?history.replaceState("data","title",i.parsedURL):history.pushState("data","title",i.parsedURL))},redirect:function(a){this.end(),k.app.go(a,"replace")}},l=-1,m=function(a){function b(){k.stack[l].isErrorHandle?k.stack[l].fn(k.state.errorStack,i,j,m):k.stack[l].fn(i,j,m)}l++,"undefined"!=typeof a&&(k.state.errorStack||(k.state.errorStack=[]),k.state.errorStack.push(a)),l>=k.stack.length?(k.state.errorStack&&console.error(k.state.errorStack),i.routed||console.error("404 not found"),j.end()):"undefined"!=typeof k.stack[l].disabled?m():"undefined"!=typeof k.stack[l].path?d(i,k.stack[l].path)?(i.routed=!0,b()):m():b()};m()},k.app.use(b),k.app.use(a),k.init=!0,k.app)}var k={init:!1};return j.Router=function(){var a=[];return{__stack:a,use:function(b){a.push(b)},route:function(b){return{get:function(){var c=Array.prototype.slice.call(arguments,0);g(c,function(c,d){a.push([b,c])})}}}}},j.Controller=function(){var a={};return function(b,c){var d="undefined"!=typeof a[b];return"function"==typeof c?(d&&console.warn("controller has exits, but this new controller will be registered: "+b),a[b]=c):d||(console.warn("controller lost fn param, but it still run: "+b),a[b]=function(a,b,c){c()}),a[b]}},j}"function"==typeof define&&define.amd?define(function(){return b()}):a.purple=b()}(this);