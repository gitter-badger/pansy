/*! PURPLE.js (DEBUG) v0.7.0-alpha 2015-10-06 */
!function(a){function b(){function a(a){for(var b in a)if(a.hasOwnProperty(b))return!1;return!0}function b(){var a={},b=Array.prototype.slice.call(arguments,0);return b.forEach(function(b,c){for(var d in b)b.hasOwnProperty(d)&&(a[d]=b[d])}),a}function c(a,b){var c=[];return a.forEach(function(a){a!==b&&c.push(a)}),c}function d(a){function c(a){return"undefined"==typeof h.app[a.name]?e(a):h.app[a.name]}return"undefined"==typeof a?c({name:"__anonymous"}):"string"==typeof a?c({name:a}):"object"==typeof a?c(b({name:"__anonymous"},a)):void 0}function e(a){console.log("正在创建app:"+a.name);var c=b({filter:{},spa:!1,timeout:45e3,exceptionHandler:function(a,b,c,d){a?(console.error(a),c.end()):d()},notFoundHandle:function(a,b){b.end()}},a),d=f({spa:!1,complete:!0,prevUrl:null,curUrl:location.href},c);return h.app[a.name]={conf:c,state:d,middleware:[],list:{},set:function(a,c){var e=this,g=b({},e.conf);"object"==typeof a?g=b(g,a):g[a]=c,g.name=e.conf.name,e.state=f(d,g),e.conf=g},use:function(a){this.middleware.push(a)},route:function(a){var b,c=this;if(a instanceof Array)b=new RegExp("(^"+a.join("$)|(^")+"$)");else if("string"==typeof a)b=new RegExp("^"+a+"$");else{if(!(a instanceof RegExp))return!1;b=a}return c.list[b]={regexp:b,get:function(){this.fns=Array.prototype.slice.call(arguments,0)}},c.list[b]},go:function(a,c){function d(a){"undefined"!=typeof a&&null!=a?f.conf.exceptionHandler(a,h,i,d):f.state.complete||(j.length>0?j.shift()(h,i,d):i.end())}function e(a,b,c){console.log("正在解析地址："+a.rawUrl);var d=a.parsedUrl,e=!0,g=d.match(f.conf.filter.pathname);if(g)if("undefined"!=typeof f.conf.filter.search){console.log("路由模式切换为使用searches参数:"+f.conf.filter.search);var h=f.conf.filter.search;d="undefined"!=typeof a.searches[h]&&""!=a.searches[h]?a.searches[h]:"/"}else d=a.pathname.substr(Object(g[0]).length);else console.warn("routePath不符合pathname过滤规则，浏览器重定向到请求网址"),location.replace(a.rawUrl);console.log("过滤后的routePath: "+d),f.state.prevUrl=f.state.curUrl,f.state.curUrl=a.parsedUrl,f.state.spa&&("replace"==a.historyStateType?history.replaceState("data","title",a.parsedURL):history.pushState("data","title",a.parsedURL));for(var i in f.list)if(f.list.hasOwnProperty(i)&&f.list[i].regexp.test(d))return console.log("解析路由成功："+f.list[i].regexp),j=j.concat(f.middleware,f.list[i].fns),e=!1,c();e&&(console.warn("该地址无法解析："+a.rawUrl),f.conf.notFoundHandle(a,b))}var f=this;if(!f.state.complete)return!1;f.state.complete=!1;var h=b(g(a),{prevUrl:f.state.curUrl,rawUrl:a,historyStateType:c||"push"}),i={end:function(){clearTimeout(k),f.state.complete=!0,console.log("路由跳转完毕。")},redirect:function(a){this.end(),f.go(a)}},j=[e].concat(f.middleware),k=setTimeout(function(){console.warn("超时"),i.end()},f.conf.timeout);d()}},h.app[a.name]}function f(a,b){function c(a){console.log("popstateHandle"),f(function(a){a||d(b.name).go(location.href)})}function e(a){h(a,function(a,c){a||d(b.name).go(c)})}function f(a){var c=d(b.name).state.curUrl,e=location.href,f=g(c),h=g(e);a(f.pathname==h.pathname&&f.search==h.search?"HASH_CHNAGED":null)}function h(a,b){function c(a){a!=document.body&&null!=a&&("A"==a.nodeName?d="undefined"==typeof a.attributes.href?null:a.attributes.href.value:c(a.parentNode))}var d=null;c(a.target),null==d?b("HREF_NOT_FOUND"):"#"==d.substr(0,1)?b("HASH_MODE"):(a.preventDefault(),b(null,d))}return b.spa&&!a.spa?(a.spa=!0,window.addEventListener("popstate",c,!1),document.addEventListener("click",e,!1)):!b.spa&&a.spa&&(a.spa=!1,window.removeEventListener("popstate",c,!1),document.removeEventListener("click",e,!1)),a}function g(b){var d=document.createElement("a");d.href=b;var e=d.pathname||"/"+d.pathname,f={rawUrl:d.href,href:d.href,origin:d.origin,source:b,protocol:d.protocol.replace(":",""),hostname:d.hostname,port:d.port,relative:(d.href.match(/tps?:\/\/[^\/]+(.+)/)||[,""])[1],pathname:e.replace(/^([^\/])/,"/$1"),pathnames:c(d.pathname.replace(/^\//,"").split("/"),""),search:d.search,searches:function(){for(var a,b={},c=d.search.replace(/^\?/,"").split("&"),e=c.length,f=0;e>f;f++)c[f]&&(a=c[f].split("="),b[a[0]]=a[1]);return b}(),hash:d.hash.replace("#",""),hashes:c(d.hash.replace(/^(#)*/i,"").replace(/^\//,"").split("/"),""),file:(d.pathname.match(/\/([^\/?#]+)$/i)||[,""])[1]},g="/"+f.pathnames.join("/");if(!a(f.searches)){g+=String("?");for(var h in f.searches)f.searches.hasOwnProperty(h)&&(g+=h+"=",g+="undefined"!=typeof f.searches[h]?f.searches[h]:"",g+="&");g=g.substring(0,g.length-1)}if(f.hashes.length>0){g+="#";for(var i=0;i<f.hashes.length;i++)g+=i<f.hashes.length-1?f.hashes[i]+String("/"):f.hashes[i]}return f.parsedURL=g,f.parsedUrl=g,f}Array.prototype.forEach||(Array.prototype.forEach=function(a){var b=this.length;if("function"!=typeof a)throw new TypeError;for(var c=arguments[1],d=0;b>d;d++)d in this&&a.call(c,this[d],d,this)});var h={app:{}};return d}"function"==typeof define&&define.amd?define(function(){return b()}):a.purple=b()}(this);